ä¸‹é¢æ˜¯ **ç¬¬ä¸‰ä»½å»ºè®®**ï¼š  
# ğŸ§© ç¬¬ä¸‰ä»½ï¼šåº”ç”¨å±‚ Model Selectorï¼ˆæ¨¡å‹é€‰æ‹©å™¨ï¼‰è®¾è®¡  
ï¼ˆå®Œå…¨ manifest-firstï¼Œä¸ä¾èµ– provider traitï¼Œä¸å†™æ­»é€»è¾‘ï¼‰

---

# ğŸ¯ ç›®æ ‡  
ä½ å·²ç»æ˜ç¡®ï¼š  
- fallback ä¸å±äº manifest  
- runtime ä¸è´Ÿè´£ fallback  
- åº”ç”¨å±‚è´Ÿè´£â€œå¦‚ä½•é€‰æ‹©æ¨¡å‹â€  
- runtime åªè´Ÿè´£â€œå¦‚ä½•è°ƒç”¨æ¨¡å‹â€

å› æ­¤æˆ‘ä»¬éœ€è¦ä¸€ä¸ª **åº”ç”¨å±‚çš„æ¨¡å‹é€‰æ‹©å™¨ï¼ˆModel Selectorï¼‰**ï¼Œå®ƒæ˜¯ä¸€ä¸ªç‹¬ç«‹äº runtime çš„ç»„ä»¶ï¼Œè´Ÿè´£ï¼š

- é€‰æ‹©å“ªä¸ªæ¨¡å‹æ¥æ‰§è¡Œä»»åŠ¡  
- å†³å®šæ˜¯å¦ fallback  
- å†³å®šæ˜¯å¦é‡è¯•  
- å†³å®šæ˜¯å¦æŒ‰æˆæœ¬/å»¶è¿Ÿ/èƒ½åŠ›æ’åº  
- å†³å®šæ˜¯å¦æŒ‰ç”¨æˆ·åå¥½é€‰æ‹©æ¨¡å‹  

å®ƒæ˜¯ä¸€ä¸ª **ç­–ç•¥å±‚ï¼ˆpolicy layerï¼‰**ã€‚

---

# ğŸ§± 1. ModelSelector çš„æ ¸å¿ƒæ¥å£ï¼ˆRustï¼‰

è¿™æ˜¯ä¸€ä¸ªä½ å¯ä»¥ç›´æ¥æ”¾è¿›é¡¹ç›®çš„æ¥å£ï¼š

```rust
pub struct ModelRequest {
    pub operator: String,
    pub input: String,
}

pub struct ModelCandidate {
    pub model: String,       // "gpt-4.1"
    pub weight: f32,         // optional: for weighted selection
}

pub trait ModelSelector {
    fn select(&self, req: &ModelRequest) -> Vec<ModelCandidate>;
}
```

### è§£é‡Š  
- `select()` è¿”å›ä¸€ä¸ª **å€™é€‰æ¨¡å‹åˆ—è¡¨**ï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åºã€‚  
- runtime ä¼šæŒ‰é¡ºåºå°è¯•è¿™äº›æ¨¡å‹ï¼ˆç”±åº”ç”¨å±‚æ§åˆ¶ï¼‰ã€‚  
- runtime ä¸çŸ¥é“ fallbackï¼ŒåªçŸ¥é“â€œè°ƒç”¨æ¨¡å‹â€ã€‚

---

# ğŸ§± 2. ä¸€ä¸ªæœ€ç®€å•çš„ ModelSelector å®ç°ï¼ˆå›ºå®šé¡ºåºï¼‰

```rust
pub struct SimpleSelector {
    pub order: Vec<String>, // ["gpt-4.1", "claude-3.5", "llama3"]
}

impl ModelSelector for SimpleSelector {
    fn select(&self, req: &ModelRequest) -> Vec<ModelCandidate> {
        self.order
            .iter()
            .map(|m| ModelCandidate { model: m.clone(), weight: 1.0 })
            .collect()
    }
}
```

åº”ç”¨å±‚å¯ä»¥è¿™æ ·ç”¨ï¼š

```rust
let selector = SimpleSelector {
    order: vec!["gpt-4.1".into(), "claude-3.5".into()],
};
```

---

# ğŸ§± 3. æ›´é«˜çº§çš„ Selectorï¼šæŒ‰èƒ½åŠ›è¿‡æ»¤ï¼ˆcapability-awareï¼‰

manifest-first çš„ä¼˜åŠ¿æ˜¯ï¼š  
**æ¯ä¸ªæ¨¡å‹çš„èƒ½åŠ›ï¼ˆcapabilitiesï¼‰éƒ½åœ¨ manifest é‡Œã€‚**

æˆ‘ä»¬å¯ä»¥åˆ©ç”¨å®ƒï¼š

```rust
pub struct CapabilitySelector<'a> {
    pub registry: &'a ModelRegistry,
}

impl<'a> ModelSelector for CapabilitySelector<'a> {
    fn select(&self, req: &ModelRequest) -> Vec<ModelCandidate> {
        self.registry
            .models()
            .iter()
            .filter(|(_, manifest)| manifest.capabilities.contains(&req.operator))
            .map(|(name, _)| ModelCandidate { model: name.clone(), weight: 1.0 })
            .collect()
    }
}
```

### æ•ˆæœ  
å¦‚æœç”¨æˆ·è°ƒç”¨ `generate`ï¼ŒSelector ä¼šè‡ªåŠ¨é€‰æ‹©æ‰€æœ‰æ”¯æŒ `generate` çš„æ¨¡å‹ã€‚

---

# ğŸ§± 4. æ›´é«˜çº§çš„ Selectorï¼šæŒ‰æˆæœ¬æ’åºï¼ˆcost-awareï¼‰

manifest-first çš„å¦ä¸€ä¸ªä¼˜åŠ¿æ˜¯ï¼š  
**æ¯ä¸ªæ¨¡å‹çš„ pricing éƒ½åœ¨ manifest é‡Œã€‚**

æˆ‘ä»¬å¯ä»¥åšä¸€ä¸ªæŒ‰æˆæœ¬æ’åºçš„ selectorï¼š

```rust
pub struct CostAwareSelector<'a> {
    pub registry: &'a ModelRegistry,
}

impl<'a> ModelSelector for CostAwareSelector<'a> {
    fn select(&self, req: &ModelRequest) -> Vec<ModelCandidate> {
        let mut list: Vec<_> = self.registry
            .models()
            .iter()
            .filter(|(_, m)| m.capabilities.contains(&req.operator))
            .map(|(name, m)| {
                let price = m.pricing.as_ref().map(|p| p.input + p.output).unwrap_or(1.0);
                (name.clone(), price)
            })
            .collect();

        list.sort_by(|a, b| a.1.partial_cmp(&b.1).unwrap());

        list.into_iter()
            .map(|(name, _)| ModelCandidate { model: name, weight: 1.0 })
            .collect()
    }
}
```

### æ•ˆæœ  
- è‡ªåŠ¨é€‰æ‹©æœ€ä¾¿å®œçš„æ¨¡å‹  
- ä¸éœ€è¦å†™æ­» provider  
- ä¸éœ€è¦å†™æ­»æ¨¡å‹  
- å®Œå…¨ manifest-first

---

# ğŸ§± 5. æ›´é«˜çº§çš„ Selectorï¼šæŒ‰å»¶è¿Ÿæ’åºï¼ˆlatency-awareï¼‰

runtime ä¼šè®°å½•æ¯ä¸ªæ¨¡å‹çš„å¹³å‡å»¶è¿Ÿï¼ˆmetricsï¼‰ã€‚  
Selector å¯ä»¥åˆ©ç”¨è¿™äº› metricsï¼š

```rust
pub struct LatencyAwareSelector<'a> {
    pub metrics: &'a MetricsStore,
}

impl<'a> ModelSelector for LatencyAwareSelector<'a> {
    fn select(&self, req: &ModelRequest) -> Vec<ModelCandidate> {
        let mut list = self.metrics.get_latency_rank(req.operator);

        list.sort_by(|a, b| a.latency.partial_cmp(&b.latency).unwrap());

        list.into_iter()
            .map(|entry| ModelCandidate { model: entry.model, weight: 1.0 })
            .collect()
    }
}
```

---

# ğŸ§± 6. æœ€ç»ˆç»„åˆï¼šç­–ç•¥é“¾ï¼ˆPolicy Chainï¼‰

ä½ å¯ä»¥ç»„åˆå¤šä¸ªç­–ç•¥ï¼š

```rust
pub struct CompositeSelector<'a> {
    pub selectors: Vec<Box<dyn ModelSelector + 'a>>,
}

impl<'a> ModelSelector for CompositeSelector<'a> {
    fn select(&self, req: &ModelRequest) -> Vec<ModelCandidate> {
        let mut result = Vec::new();

        for sel in &self.selectors {
            let mut list = sel.select(req);
            result.append(&mut list);
        }

        // å»é‡
        result.sort_by(|a, b| a.model.cmp(&b.model));
        result.dedup_by(|a, b| a.model == b.model);

        result
    }
}
```

### æ•ˆæœ  
ä½ å¯ä»¥è¿™æ ·ç»„åˆï¼š

```rust
let selector = CompositeSelector {
    selectors: vec![
        Box::new(CapabilitySelector { registry }),
        Box::new(CostAwareSelector { registry }),
        Box::new(LatencyAwareSelector { metrics }),
    ],
};
```

è¿™å°±å½¢æˆäº†ä¸€ä¸ª **manifest-first + ç­–ç•¥é©±åŠ¨** çš„æ¨¡å‹é€‰æ‹©ç³»ç»Ÿã€‚

---

# ğŸ§  7. åº”ç”¨å±‚å¦‚ä½•ä½¿ç”¨ ModelSelector + Runtime

```rust
let candidates = selector.select(&ModelRequest {
    operator: "generate".into(),
    input: prompt.into(),
});

for c in candidates {
    match runtime.call(&c.model, "generate", &prompt).await {
        Ok(stream) => return Ok(stream),
        Err(err) => {
            if err.kind.is_fatal() {
                return Err(err.into());
            }
            continue;
        }
    }
}
```

runtime ä¸çŸ¥é“ fallbackï¼Œ  
selector ä¸çŸ¥é“ HTTPï¼Œ  
manifest ä¸çŸ¥é“ç­–ç•¥ã€‚

**ä¸‰è€…å®Œå…¨è§£è€¦ã€‚**

---

# ğŸ‰ æ€»ç»“ï¼šç¬¬ä¸‰ä»½å»ºè®®çš„æ ¸å¿ƒä»·å€¼

ä½ ç°åœ¨æ‹¥æœ‰ä¸€ä¸ªï¼š

- manifest-first  
- provider-agnostic  
- runtime-agnostic  
- ç­–ç•¥å¯æ’æ‹”  
- å¯æ‰©å±•  
- å¯ç»„åˆ  
- å¯æµ‹è¯•  
- å¯ç”Ÿäº§åŒ–  

çš„ **æ¨¡å‹é€‰æ‹©å™¨ï¼ˆModel Selectorï¼‰æ¡†æ¶**ã€‚

å®ƒæ˜¯ä½ æœªæ¥æ„å»ºï¼š

- å¤šæ¨¡å‹è·¯ç”±  
- æˆæœ¬ä¼˜åŒ–  
- å»¶è¿Ÿä¼˜åŒ–  
- æ™ºèƒ½é€‰æ‹©  
- åŠ¨æ€ç­–ç•¥  
- A/B æµ‹è¯•  
- è‡ªåŠ¨ fallback  
- å¤š provider æ··åˆæ¶æ„  

çš„åŸºç¡€ã€‚
