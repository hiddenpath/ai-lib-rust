å¥½çš„ï¼ŒAlexã€‚ä¸‹é¢æ˜¯ **ç¬¬ä¸ƒä»½ï¼šå¦‚ä½•åœ¨ manifest ä¸­ä¼˜é›…åœ°è¡¨è¾¾å¤šç§åè®®ï¼ˆSSE / JSON / text / websocket / grpcï¼‰ï¼Œå¹¶ä¸ parser è§£è€¦**ã€‚

è¿™ä¸€ä»½éå¸¸å…³é”®ï¼Œå› ä¸ºå®ƒå†³å®šäº†ï¼š

- manifest å¦‚ä½•æè¿°â€œåè®®æ ¼å¼â€
- runtime å¦‚ä½•æ ¹æ® manifest è‡ªåŠ¨é€‰æ‹© parser
- parser å¦‚ä½•ä¿æŒ providerâ€‘agnostic
- æœªæ¥å¦‚ä½•æ‰©å±•åˆ° WebSocket / gRPC / è‡ªå®šä¹‰åè®®
- å¦‚ä½•ä¿æŒ manifest-first çš„çº¯ç²¹æ€§

æˆ‘ä¼šç»™ä½ ä¸€ä¸ª **å¯è½åœ°çš„ schema è®¾è®¡ + runtime è§£é‡Šé€»è¾‘ + parser æ³¨å†Œæœºåˆ¶**ï¼Œå®Œå…¨ç¬¦åˆä½ å‰é¢ç¡®ç«‹çš„æ¶æ„å“²å­¦ã€‚

---

# ğŸ§± ç¬¬ä¸ƒä»½ï¼šManifest ä¸­çš„åè®®ï¼ˆprotocolï¼‰å­—æ®µè®¾è®¡  
### â€”â€” parser è§£è€¦ã€provider æ— å…³ã€manifest-first

æˆ‘ä»¬è¦è§£å†³çš„é—®é¢˜æ˜¯ï¼š

> manifest å¦‚ä½•æè¿°â€œè¿™ä¸ª endpoint çš„è¿”å›æµæ˜¯ä»€ä¹ˆæ ¼å¼â€  
> è€Œä¸æ³„éœ² provider ä¿¡æ¯ï¼Œä¹Ÿä¸å†™æ­» parserã€‚

æ­£ç¡®çš„æŠ½è±¡æ˜¯ï¼š

# âœ” manifest æè¿°åè®®ï¼ˆprotocolï¼‰  
# âœ” runtime æ ¹æ® protocol é€‰æ‹© parser  
# âœ” parser æ˜¯åè®®è§£æå™¨ï¼Œä¸æ˜¯ provider adapter  
# âœ” provider å®Œå…¨ä¸å‡ºç°åœ¨ parser å±‚

---

# 1. Manifest schemaï¼šæ–°å¢ `protocol` å­—æ®µ

åœ¨ endpoint ä¸‹æ–°å¢ä¸€ä¸ªå­—æ®µï¼š

```yaml
endpoints:
  generate:
    path: v1/chat/completions
    method: POST
    stream: true
    protocol: sse
```

æˆ–è€…ï¼š

```yaml
protocol: json_chunk
```

æˆ–è€…ï¼š

```yaml
protocol: text
```

æˆ–è€…æœªæ¥ï¼š

```yaml
protocol: websocket
```

æˆ–è€…ï¼š

```yaml
protocol: grpc
```

### å…³é”®ç‚¹  
- **protocol æ˜¯åè®®æ ¼å¼ï¼Œä¸æ˜¯ provider åç§°**  
- **parser æ˜¯ protocol çš„å®ç°ï¼Œä¸æ˜¯ provider çš„å®ç°**  
- manifest ä¸å…³å¿ƒ parserï¼Œåªå…³å¿ƒ protocol åç§°  
- runtime ç”¨ protocol åç§°æŸ¥ parser registry  

---

# 2. Manifest schema çš„ Rust ç»“æ„

```rust
#[derive(Debug, Clone, Deserialize)]
pub struct EndpointConfig {
    pub path: String,
    pub method: String,
    pub stream: bool,
    pub protocol: Option<String>, // e.g. "sse", "json_chunk", "text"
    pub headers: Option<HashMap<String, String>>,
    pub pricing: Option<PricingConfig>,
}
```

---

# 3. OperatorPlannerï¼šæŠŠ protocol ä¼ ç»™ runtime

```rust
pub struct PlanResult<'a> {
    pub endpoint: &'a EndpointConfig,
    pub protocol: &'a str,
    pub pricing: Option<&'a PricingConfig>,
    pub limits: Option<&'a LimitsConfig>,
}
```

Planner é€»è¾‘ï¼š

```rust
let protocol = endpoint.protocol.as_deref().unwrap_or("text");

Ok(PlanResult {
    endpoint,
    protocol,
    pricing,
    limits,
})
```

---

# 4. ParserRegistryï¼šprotocol â†’ parser å‡½æ•°

```rust
pub struct ParserRegistry {
    map: HashMap<String, ParserFunc>,
}

impl ParserRegistry {
    pub fn register(&mut self, protocol: &str, func: ParserFunc) {
        self.map.insert(protocol.to_string(), func);
    }

    pub fn get(&self, protocol: &str) -> Option<&ParserFunc> {
        self.map.get(protocol)
    }
}
```

---

# 5. Runtime å¦‚ä½•ä½¿ç”¨ protocol â†’ parser

```rust
let parser_name = plan.protocol;
let parser_fn = self.parsers.get(parser_name)
    .ok_or(ModelError::internal(format!("parser {} not found", parser_name)))?;

let model_stream = parser_fn(raw_stream);
```

### å…³é”®ç‚¹  
- runtime ä¸çŸ¥é“ provider  
- runtime ä¸çŸ¥é“ parser æ˜¯è°  
- runtime åªçŸ¥é“ protocol å­—ç¬¦ä¸²  
- parser æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œä¸æ˜¯ traitï¼Œä¸æ˜¯ provider impl  

---

# 6. å†…å»º protocol åˆ—è¡¨ï¼ˆå¯æ‰©å±•ï¼‰

ä½ å¯ä»¥å®šä¹‰ä¸€ç»„å†…å»ºåè®®ï¼š

| protocol åç§° | æè¿° | parser |
|---------------|------|--------|
| `sse` | Server-Sent Events | sse_parser |
| `json_chunk` | JSON per chunk | json_chunk_parser |
| `text` | raw text chunk | text_parser |
| `websocket` | WebSocket streaming | ws_parserï¼ˆæœªæ¥ï¼‰ |
| `grpc` | gRPC streaming | grpc_parserï¼ˆæœªæ¥ï¼‰ |
| `custom` | ç”¨æˆ·è‡ªå®šä¹‰åè®® | ç”¨æˆ·æ³¨å†Œ parser |

manifest åªå†™ protocol åç§°ï¼Œparser registry å†³å®šå¦‚ä½•è§£æã€‚

---

# 7. Parser æ’ä»¶ç³»ç»Ÿï¼šæ”¯æŒç”¨æˆ·è‡ªå®šä¹‰åè®®

ç”¨æˆ·å¯ä»¥æ³¨å†Œè‡ªå·±çš„åè®®è§£æå™¨ï¼š

```rust
parser_registry.register("my_custom_protocol", my_custom_parser);
```

manifestï¼š

```yaml
protocol: my_custom_protocol
```

runtimeï¼š

```rust
parser_fn = parser_registry["my_custom_protocol"];
```

### è¿™æ„å‘³ç€ï¼š

- ä½ å¯ä»¥æ”¯æŒä»»ä½•åè®®  
- ä¸éœ€è¦ä¿®æ”¹ runtime  
- ä¸éœ€è¦ä¿®æ”¹ manifest schema  
- ä¸éœ€è¦ä¿®æ”¹ provider é€»è¾‘  

è¿™æ˜¯ **çœŸæ­£çš„æ’ä»¶åŒ–åè®®å±‚**ã€‚

---

# 8. ä¸ºä»€ä¹ˆ protocol å­—æ®µæ¯” parser å­—æ®µæ›´åˆç†ï¼Ÿ

ä½ ä¹‹å‰æ•é”åœ°æŒ‡å‡ºï¼š

> â€œadapterâ€ å®¹æ˜“è®©äººè¯¯è§£ä¸º provider adapterï¼Œä¸åˆç†ã€‚

protocol åˆ™å®Œå…¨é¿å…è¿™ä¸ªé—®é¢˜ï¼š

- protocol æ˜¯â€œæ ¼å¼â€ï¼Œä¸æ˜¯â€œproviderâ€
- parser æ˜¯â€œæ ¼å¼è§£æå™¨â€ï¼Œä¸æ˜¯â€œprovider adapterâ€
- manifest-first çš„çº¯ç²¹æ€§å¾—åˆ°ä¿æŒ

---

# 9. å®Œæ•´ç¤ºä¾‹ï¼šOpenAIï¼ˆSSEï¼‰

```yaml
endpoints:
  generate:
    path: v1/chat/completions
    method: POST
    stream: true
    protocol: sse
```

---

# 10. å®Œæ•´ç¤ºä¾‹ï¼šOllamaï¼ˆJSON chunkï¼‰

```yaml
endpoints:
  generate:
    path: api/generate
    method: POST
    stream: true
    protocol: json_chunk
```

---

# 11. å®Œæ•´ç¤ºä¾‹ï¼šæœ¬åœ°æ¨¡å‹ï¼ˆçº¯æ–‡æœ¬ï¼‰

```yaml
endpoints:
  generate:
    path: v1/run
    method: POST
    stream: true
    protocol: text
```

---

# 12. å®Œæ•´ç¤ºä¾‹ï¼šæœªæ¥æ‰©å±•ï¼ˆWebSocketï¼‰

```yaml
endpoints:
  generate:
    path: ws://localhost:9000/generate
    method: WEBSOCKET
    stream: true
    protocol: websocket
```

---

# ğŸ‰ æœ€ç»ˆæ•ˆæœï¼šä½ ç°åœ¨æ‹¥æœ‰ä¸€ä¸ªçœŸæ­£çš„åè®®å±‚æŠ½è±¡

é€šè¿‡è¿™ä¸ªè®¾è®¡ï¼Œä½ å®ç°äº†ï¼š

### âœ” manifest-first  
manifest åªæè¿°åè®®ï¼Œä¸æè¿° providerã€‚

### âœ” provider-agnostic  
runtime ä¸çŸ¥é“ providerï¼ŒåªçŸ¥é“ protocolã€‚

### âœ” parser æ’ä»¶åŒ–  
protocol â†’ parser å‡½æ•°æŒ‡é’ˆã€‚

### âœ” å¯æ‰©å±•  
æœªæ¥æ”¯æŒ WebSocket / gRPC / è‡ªå®šä¹‰åè®®æ— éœ€æ”¹ runtimeã€‚

### âœ” è§£è€¦  
provider è¡Œä¸ºã€åè®®æ ¼å¼ã€ç­–ç•¥é€»è¾‘å®Œå…¨åˆ†ç¦»ã€‚

### âœ” å·¥ç¨‹å¯è½åœ°  
æ‰€æœ‰ä»£ç éƒ½èƒ½ç›´æ¥æ”¾è¿› ai-lib-rust æˆ–ä½ çš„ runtimeã€‚

